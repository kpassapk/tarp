################################################################################
# TARP INSTALL SCRIPT
#
# This script installs the Tarp Toolkit.
#
# INSTRUCTIONS
#
# In order to install the Toolkit, first unpack the distribution to
# a temporary directory.  Then run the install.pl script in the command line
# (from the temporary directory):
#
#    perl install.pl
#
# ---------------------- INSTALL OPTIONS (modify below) ------------------------
#
my %installOptions = (

#   Option    #  Value                  Description
#''''''''''''''''''''''''''#''''''''''''''''''''''''''''''''''''''''''''''''''''
    buildTool => "make",  # Build tool to use (e.g. make or nmake)
              #
    force     => 1,        # Install even if tests are unsuccessful
              #            # Default is true (1).
              #            
    install   => 1,        # Install apps & modules (if zero, then the
              #            # apps & modules will only be tested, but not
              #            # actually installed). Default is true (1).
              #            
    clean     => 1,        # Do not install, only clean. Default is 0.
              #            # If this is set to 1, "install" and "force" will
              #            # be ignored.
);            #
################################################################################

# No changes below this point!

sub checkRequirements {
    my $installer = shift;
    $installer->checkRequirements();
}

sub installAppsAndModules {
    my $installer = shift;
        
    chdir "Modules" or die "Could not cd to Modules: $!";
    
    $installer->install( qw/Tarp Tarp::GenPK/ ); 
    
    chdir "..";
    
    chdir "Apps" or die "Could not cd to Apps: $!";

    $installer->install( qw/ Tarp::LaTeXtract / );

    chdir "../Modules" or die "Could not cd to Modules: $!";

    $installer->install( map { "Tarp::$_" } qw/Itexam GenSkel Burn varExtract/ );

    chdir "../Apps" or die "Could not cd to Apps: $!";

    $installer->install( map { "Tarp::$_" } qw/PullCSV MasterAlloc LaTeXcombine GenTex Launcher/ );

    chdir ( ".." );
}

sub installGUI {
    my $installer = shift;
    $installer->installGUI();
}

sub installUserData {
    my $installer = shift;
    $installer->installUserData();
}

sub installPlugins {
    my $installer = shift;
    $installer->install( "Tarp::Plugins" );
}

sub installScripts {
    my $installer = shift;
    $installer->installScripts();
}

sub printResults {
    my $installer = shift;
    $installer->printResults();
    eval "use Tarp::Config";
    die $@ if $@;
    my $logFile = File::Spec->catfile( Tarp::Config->InstallDir(), "install.log" );
    if ( open( LOG, '>', $logFile ) ) {
        #  0    1    2     3     4    5     6     7     8
        my ($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) =
                                                    localtime(time);
        print LOG "Last installation $mon\/$mday\/$year at $hour:$min:$sec\n\n";
        select LOG;
        $installer->printResults();
        select STDOUT;
        close LOG;
        print "Summary also written to $logFile\n";
    }
}

sub showReleaseNotes {
    eval 'use ActiveState::Browser';
    if ( ! $@ ) {
        my $f = File::Spec->catfile( cwd(), "Resources", "Installer", "README.html" );
        if ( ActiveState::Browser::can_open( $f ) ) {
            ActiveState::Browser::open( $f );
        }
    }
}

BEGIN {
    use Cwd;
    our $directory = cwd;
    use File::Spec;
    our $libDir = File::Spec->catfile( $directory, "Resources", "Installer", "lib" );    
}

use lib $libDir;
use Tarp::Installer2;

my @ACTIONS = (
    \&checkRequirements,        # 0
    \&installAppsAndModules,    # 1
    \&printResults,             # 6
    \&installUserData,          # 2
    \&installPlugins,           # 3
    \&installGUI,               # 4
    \&installScripts,           # 5
    \&printResults,             # 6
    \&showReleaseNotes          # 7
);

my $steps = "0..7";
if ( @ARGV ) {
    
    if ( $ARGV[0] eq "--help" ) {
        print <<INSTS;
usage: install.pl [steps]

Steps:
    checkRequirements,        # 0
    installAppsAndModules,    # 1
    installUserData,          # 2
    installPlugins,           # 3
    installGUI,               # 4
    installScripts,           # 5
    printResults,             # 6
    showReleaseNotes          # 7

INSTS
        exit 1;
    } else {
        $steps = shift;
        my @s;
        eval "\@s = ( $steps )";
        die "Invalid range: '$steps', stopped" if $@;
        print "@s\n";
        while ( @s > 1 ) {
            die "Out of order instruction: $steps, stopped"
                if ( $s[1] < shift @s );
        }
    }
}

my @DO;

if ( $installOptions{ "clean" } ) {
    @DO = @ACTIONS[ 1, 3 ]; # Only install (clean) apps & modules
} else {
    eval "\@DO = \@ACTIONS[ $steps ]";
    die "Invalid range: '$steps', stopped" if $@;
}

$| = 1; # Flush output buffers with print()

my $installer = Tarp::Installer2->new( \%installOptions );

$installer->printHeading();

for my $act ( @DO ) {
    &$act( $installer );
}

